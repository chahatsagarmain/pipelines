name: Validate Generated Files

on:
  pull_request:
    paths:
      - 'backend/api/**/*.proto'
      - '.github/workflows/check-generated-diff.yml'
      - 'backend/api/**/go_http_client/**'
      - 'backend/api/**/go_client/**'
      - 'backend/api/**/python_http_client/**'
      - 'backend/api/**/swagger/**'

jobs:
  validate-generated-files:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        api_version: ['v1beta1', 'v2beta1']
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'

      - name: Set up environment
        run: |
          echo "GOPATH=${GITHUB_WORKSPACE}/go" >> $GITHUB_ENV
          echo "KFP_REPO_PATH=${GITHUB_WORKSPACE}" >> $GITHUB_ENV
          echo "API_VERSION=${{ matrix.api_version }}" >> $GITHUB_ENV
          echo "PROTOCCOMPILER=protoc" >> $GITHUB_ENV
          echo "TMP_OUTPUT=/tmp" >> $GITHUB_ENV
          mkdir -p ${GITHUB_WORKSPACE}/go/src/github.com/kubeflow
          ln -s ${GITHUB_WORKSPACE} ${GITHUB_WORKSPACE}/go/src/github.com/kubeflow/pipelines

      - name: Install Dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler jq default-jdk
          go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway@latest
          go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger@latest
          go install github.com/golang/protobuf/protoc-gen-go@latest
          go install github.com/go-swagger/go-swagger/cmd/swagger@latest
          python3 -m pip install setuptools wheel

      - name: Generate Proto Files
        env:
          PROTOCCOMPILER: protoc
          KFP_REPO_PATH: ${{ github.workspace }}
          API_VERSION: ${{ matrix.api_version }}
          TMP_OUTPUT: /tmp
        run: |
          cd $KFP_REPO_PATH
          ./backend/api/hack/generator.sh

      - name: Generate Python Package
        run: |
          cd ${{ github.workspace }}
          ./backend/api/build_kfp_server_api_python_package.sh

      - name: Check for Changes
        run: |
          cd ${{ github.workspace }}
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "::error::Generated files are out of date for API version ${{ matrix.api_version }}. Please run backend/api/hack/generator.sh and backend/api/build_kfp_server_api_python_package.sh"
            git status
            git diff
            exit 1
          fi